#!/bin/bash

# Chronos Load Test Script
# Tests throughput and latency using redis-benchmark

echo "==================================="
echo "Chronos Cache Load Test"
echo "==================================="
echo ""

# Configuration
HOST="localhost"
PORT="6380"
CLIENTS=50
REQUESTS=1000000
DATA_SIZE=1024

echo "Configuration:"
echo "  Host: $HOST:$PORT"
echo "  Clients: $CLIENTS"
echo "  Requests: $REQUESTS"
echo "  Data Size: $DATA_SIZE bytes"
echo ""

# Check if redis-benchmark is available
if ! command -v redis-benchmark &> /dev/null; then
    echo "ERROR: redis-benchmark is not installed"
    echo "Install with: sudo apt-get install redis-tools"
    exit 1
fi

# Check if Chronos is running
echo "Checking if Chronos is running..."
timeout 2 bash -c "</dev/tcp/$HOST/$PORT" 2>/dev/null
if [ $? -ne 0 ]; then
    echo "ERROR: Chronos is not running on $HOST:$PORT"
    echo "Start with: docker-compose up -d chronos"
    exit 1
fi
echo "✓ Chronos is running"
echo ""

# Run GET/SET benchmark
echo "Running GET/SET benchmark..."
redis-benchmark -h $HOST -p $PORT -t get,set -n $REQUESTS -c $CLIENTS -d $DATA_SIZE \
    --csv > load-tests/results-get-set.csv

echo ""
echo "✓ GET/SET benchmark complete"
echo ""

# Run mixed workload (80% GET, 20% SET)
echo "Running mixed workload benchmark (80% GET, 20% SET)..."
redis-benchmark -h $HOST -p $PORT -n $REQUESTS -c $CLIENTS -d $DATA_SIZE \
    -r 10000 --csv > load-tests/results-mixed.csv

echo ""
echo "✓ Mixed workload benchmark complete"
echo ""

# Run latency test
echo "Running latency test..."
redis-benchmark -h $HOST -p $PORT -t get -n 10000 -c 1 -d $DATA_SIZE \
    --csv > load-tests/results-latency.csv

echo ""
echo "✓ Latency test complete"
echo ""

# Parse and display results
echo "==================================="
echo "RESULTS SUMMARY"
echo "==================================="
echo ""

if [ -f "load-tests/results-get-set.csv" ]; then
    echo "GET/SET Performance:"
    awk -F',' 'NR>1 {printf "  %s: %s ops/sec\n", $1, $2}' load-tests/results-get-set.csv
    echo ""
fi

echo "Detailed results saved to load-tests/ directory"
echo ""

# Generate summary report
cat > load-tests/RESULTS.md << EOF
# Chronos Load Test Results

**Test Date**: $(date)
**Configuration**: $CLIENTS clients, $REQUESTS requests, $DATA_SIZE byte values

## GET/SET Performance

\`\`\`csv
$(cat load-tests/results-get-set.csv)
\`\`\`

## Mixed Workload (80% GET, 20% SET)

\`\`\`csv
$(cat load-tests/results-mixed.csv)
\`\`\`

## Latency Results

\`\`\`csv
$(cat load-tests/results-latency.csv)
\`\`\`

---
Generated by Chronos load test script
EOF

echo "Full report saved to: load-tests/RESULTS.md"
